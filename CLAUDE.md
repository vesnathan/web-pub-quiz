# Quiz Night Live - Claude Code Guide

## Project Overview

**Quiz Night Live (QNL)** - Real-time pub quiz application.
- Full-stack AWS AppSync/GraphQL application with Cognito authentication
- Real-time features using Ably for pub quiz hosting
- Next.js frontend with TypeScript

**Location**: `/home/liqk1ugzoezh5okwywlr_/dev/quiz-app/`

---

## Shared Documentation

**IMPORTANT**: Read the architecture guidelines that apply to ALL projects:

- **Architecture Guidelines**: `/home/liqk1ugzoezh5okwywlr_/dev/ARCHITECTURE_GUIDELINES.md`
  - Includes all standards, patterns, and project compliance status

**Reference Implementation**: Check The Story Hub for patterns:
- `/home/liqk1ugzoezh5okwywlr_/dev/the-story-hub/`

---

## Code Generation

- Types in `shared/src/types/gqlTypes.ts` are automatically generated by codegen
- **Do NOT manually edit `gqlTypes.ts`** - changes will be overwritten
- To add new types, update the GraphQL schema and run codegen

---

## AppSync Resolver Restrictions

AppSync resolvers run in a restricted JavaScript environment.

### Required Patterns

- **Imports**: `import { util, Context } from "@aws-appsync/utils"`
- **IDs**: `util.autoId()` - NOT `uuid`
- **Timestamps**: `util.time.nowISO8601()` - NOT `new Date().toISOString()`
- **DynamoDB**: `util.dynamodb.toMapValues()` for converting objects
- **Errors**: `return util.error(message, type)` - MUST include `return`

### NOT Allowed

- `new Date()`, `Date.now()` - causes deployment failure
- `String()` constructor - use template literal: `` `${value}` ``
- External npm packages (uuid, etc.)
- Node.js built-in modules
- `while`, `do...while` loops
- **ALL traditional `for` loops** - only `for...of` and `for...in` allowed
- **Inline functions** in array methods (`.map()`, `.filter()`, `.sort()`)
- `continue` statements

### util.error() Must Be Called at Top Level

```typescript
// CORRECT: util.error() at top level
export function request(ctx) {
  const result = validateInput(ctx.args.input);
  if ("errorMessage" in result) {
    return util.error(result.errorMessage, result.errorType);
  }
}

// WRONG: util.error() in helper function - AppSync rejects this!
function validateInput(input) {
  return util.error("Invalid", "ValidationException");
}
```

### Resolver Structure

- **Location**: `backend/resolvers/<domain>/<type>/<Type>.<operationName>.ts`
- **CloudFormation config**: `deploy/resources/AppSync/appsync.yaml`
- **Compiler**: `deploy/utils/resolver-compiler.ts`

---

## Project Structure

```
quiz-app/
├── frontend/
│   ├── src/
│   │   ├── app/           # Next.js App Router
│   │   ├── components/    # UI components
│   │   ├── graphql/       # Queries, mutations
│   │   ├── hooks/         # Custom hooks (useAbly, useAntiCheat)
│   │   ├── lib/           # Business logic
│   │   └── types/         # TypeScript types
├── backend/
│   ├── resolvers/         # AppSync resolvers
│   ├── lambda/            # Lambda functions (webhooks)
│   └── src/orchestrator/  # Quiz orchestration logic
├── shared/
│   └── src/types/         # Shared gqlTypes.ts
└── deploy/                # CloudFormation templates
```

---

## Commands

### Development

```bash
yarn dev                   # Start frontend dev server
yarn build                 # Build frontend
yarn lint                  # Run linter
yarn tsc                   # Type check TypeScript
```

### Deployment (USER ONLY - NEVER run automatically)

```bash
yarn workspace @quiz/deploy deploy:dev   # Deploy to dev
yarn workspace @quiz/deploy deploy:prod  # Deploy to prod
```

**Building the frontend (`yarn build`) is fine without permission.**
**Compiling/validating resolvers is fine, but don't deploy to AWS.**

---

## Git Commit Process

**ALWAYS run BEFORE staging and committing:**

1. `yarn lint` - Run linter
2. `yarn tsc` - Type check TypeScript
3. Format with Prettier if available

Only proceed with `git add` and `git commit` after all checks pass.

---

## Logging

Deploy logs should be written to `~/dev/quiz-app/.cache/logs/` directory.

---

## Project-Specific Notes

### Real-Time Features
- Uses Ably for real-time pub quiz hosting
- Custom hooks: `useAbly.ts`, `useAntiCheat.ts`

### Payment Webhooks
- Stripe webhook: `/backend/lambda/stripeWebhook.ts`
- PayPal webhook: `/backend/lambda/paypalWebhook.ts`

### Quiz Orchestration
- Question generation: `/backend/src/orchestrator/questionGenerator.ts`
- Main orchestrator: `/backend/src/orchestrator/index.ts`

---

## Notes for Future Sessions

- Always read this file at the start of a new session
- Update this file with significant changes and lessons learned
- User prefers concise, technical communication
- Focus on facts and problem-solving over validation
