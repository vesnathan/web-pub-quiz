# --- 00-base.graphql ---
# Base schema with Query, Mutation, and Subscription roots

type Query {
  # User queries
  getMyProfile: User @aws_cognito_user_pools
  getUserProfile(userId: ID!): UserPublic
  checkDisplayNameAvailable(displayName: String!): Boolean! @aws_iam
  checkEmailHasGoogleAccount(email: String!): Boolean! @aws_iam
  checkEmailHasFacebookAccount(email: String!): Boolean! @aws_iam

  # Leaderboard queries
  getLeaderboard(type: LeaderboardType!, limit: Int): Leaderboard
  getMyRank(type: LeaderboardType!): Int @aws_cognito_user_pools

  # Game state queries
  getGameState: GameState

  # Room list query (polled by frontend every 10 seconds)
  getRoomList: RoomListState @aws_iam @aws_cognito_user_pools

  # Question queries (admin only)
  listQuestions(limit: Int, nextToken: String): QuestionConnection @aws_cognito_user_pools

  # Ably token for real-time
  getAblyToken: AblyTokenResponse @aws_cognito_user_pools

  # Chat queries
  getChatMessages(channelId: ID!, limit: Int, nextToken: String): ChatMessageConnection @aws_cognito_user_pools
  getMyConversations(limit: Int): [Conversation!]! @aws_cognito_user_pools

  # Admin queries
  getWebhookLogs(provider: String, limit: Int, nextToken: String): WebhookLogConnection! @aws_cognito_user_pools
  getReports(status: ReportStatus, limit: Int, nextToken: String): ReportConnection! @aws_cognito_user_pools
  getUserModeration(userId: ID!): UserModeration @aws_cognito_user_pools

  # Game config (admin only)
  getGameConfig: GameConfig @aws_cognito_user_pools

  # User notification queries
  getMyNotifications(limit: Int, nextToken: String): AdminMessageConnection! @aws_cognito_user_pools
  getUnreadNotificationCount: Int! @aws_cognito_user_pools
}

# Room list state from orchestrator (stored in DynamoDB)
type RoomListState @aws_iam @aws_cognito_user_pools {
  rooms: [RoomInfo!]!
  lobbyPlayerCount: Int!
  maintenanceMode: Boolean!
  maintenanceMessage: String
  updatedAt: String!
}

type RoomInfo @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String!
  status: String!
  difficulty: String!
  currentPlayers: Int!
  maxPlayers: Int!
  inProgress: Boolean!
  currentQuestion: Int
}

type DeleteAccountResult {
  success: Boolean!
  message: String!
}

type Mutation {
  # User mutations
  updateDisplayName(displayName: String!): User @aws_cognito_user_pools
  ensureProfile(displayName: String!): User @aws_cognito_user_pools
  deleteMyAccount: DeleteAccountResult! @aws_cognito_user_pools

  # Subscription mutations
  createCheckoutSession(input: CreateCheckoutInput!): CheckoutSession @aws_cognito_user_pools

  # Tip jar mutation
  createTipCheckout(provider: SubscriptionProvider!): CheckoutSession @aws_cognito_user_pools

  # Admin mutations
  createQuestion(input: CreateQuestionInput!): Question @aws_cognito_user_pools
  seedQuestions(questions: [CreateQuestionInput!]!): Int @aws_cognito_user_pools

  # Chat mutations (needed in base for @aws_subscribe to work)
  sendChatMessage(channelId: ID!, content: String!): ChatMessage @aws_cognito_user_pools
  startConversation(targetUserId: ID!, targetDisplayName: String!): Conversation @aws_cognito_user_pools

  # Admin mutations
  adminUpdateUserTier(userId: ID!, tier: Int!): User @aws_cognito_user_pools
  adminGiftSubscription(input: GiftSubscriptionInput!): User @aws_cognito_user_pools

  # Gift notification mutations
  markGiftNotificationSeen: Boolean @aws_cognito_user_pools

  # Game config mutations (admin only)
  updateGameConfig(input: UpdateGameConfigInput!): GameConfig @aws_cognito_user_pools

  # Invite mutations
  sendInvite(friendName: String!, email: String!, recaptchaToken: String!): Boolean @aws_cognito_user_pools
  recordReferral(referrerId: ID!): Boolean @aws_cognito_user_pools

  # Contact form mutation (public - uses reCAPTCHA for protection)
  sendContact(name: String!, email: String!, subject: String!, message: String!, recaptchaToken: String!): Boolean @aws_iam

  # Report user mutation
  reportUser(input: ReportUserInput!): ReportUserResult! @aws_cognito_user_pools

  # Admin report management
  updateReportStatus(input: UpdateReportStatusInput!): Report @aws_cognito_user_pools
  sendAdminMessage(input: SendAdminMessageInput!): AdminMessage @aws_cognito_user_pools

  # User notification mutations
  markNotificationRead(notificationId: ID!): Boolean @aws_cognito_user_pools
  markAllNotificationsRead: Boolean @aws_cognito_user_pools

  # Moderation mutations (admin only)
  addStrike(input: AddStrikeInput!): ModerationResult! @aws_cognito_user_pools
  removeStrike(userId: ID!, strikeId: ID!): ModerationResult! @aws_cognito_user_pools
  banUser(input: BanUserInput!): ModerationResult! @aws_cognito_user_pools
  unbanUser(userId: ID!): ModerationResult! @aws_cognito_user_pools
}

type Subscription {
  # Chat subscriptions
  onNewChatMessage(channelId: ID!): ChatMessage @aws_subscribe(mutations: ["sendChatMessage"]) @aws_cognito_user_pools
}


# --- Admin.graphql ---
# Admin types and queries

type WebhookLog {
  eventId: ID!
  provider: String!
  eventType: String!
  payload: String!
  status: String!
  errorMessage: String
  email: String
  createdAt: String!
}

type WebhookLogConnection {
  items: [WebhookLog!]!
  nextToken: String
}

# Game configuration (admin-editable, no deployment required)
type DifficultyPointsConfig {
  correct: Int!
  wrong: Int!
}

type GameDifficultyPoints {
  easy: DifficultyPointsConfig!
  medium: DifficultyPointsConfig!
  hard: DifficultyPointsConfig!
}

type GameConfig {
  maxPlayersPerRoom: Int!
  playersPerRoomThreshold: Int!
  resultsDisplayMs: Int!
  questionDurationMs: Int!
  freeTierDailyLimit: Int!
  difficultyPoints: GameDifficultyPoints!
  maintenanceMode: Boolean!
  maintenanceMessage: String
  stripeTestMode: Boolean!
  updatedAt: String!
  updatedBy: String
}

input DifficultyPointsInput {
  correct: Int!
  wrong: Int!
}

input GameDifficultyPointsInput {
  easy: DifficultyPointsInput!
  medium: DifficultyPointsInput!
  hard: DifficultyPointsInput!
}

input UpdateGameConfigInput {
  maxPlayersPerRoom: Int
  playersPerRoomThreshold: Int
  resultsDisplayMs: Int
  questionDurationMs: Int
  freeTierDailyLimit: Int
  difficultyPoints: GameDifficultyPointsInput
  maintenanceMode: Boolean
  maintenanceMessage: String
  stripeTestMode: Boolean
}

# Query fields are defined in 00-base.graphql to avoid extend type issues with AppSync


# --- Badge.graphql ---
# Badge and Award types

enum AwardRarity {
  common
  uncommon
  rare
  epic
  legendary
}

type Badge {
  id: ID!
  name: String!
  description: String!
  icon: String!
  groupId: String!
  tier: Int!
  rarity: AwardRarity!
  skillPoints: Int!
  earnedAt: String!
}

type BadgeGroup {
  id: ID!
  name: String!
  description: String!
  showHighestOnly: Boolean!
  badges: [BadgeDefinition!]!
}

type BadgeDefinition {
  id: ID!
  name: String!
  description: String!
  icon: String!
  groupId: String!
  tier: Int!
  rarity: AwardRarity!
  skillPoints: Int!
  requirement: Int!
}

# User's badge summary for display
type UserBadgeSummary {
  badges: [Badge!]!
  totalSkillPoints: Int!
  badgeCount: Int!
}


# --- Chat.graphql ---
# Chat types
# Note: Chat queries, mutations and subscriptions are in 00-base.graphql

type ChatMessage {
  id: ID!
  channelId: ID!
  senderId: ID!
  senderUsername: String!
  senderDisplayName: String!
  content: String!
  createdAt: String!
}

type ChatMessageConnection {
  items: [ChatMessage!]!
  nextToken: String
}

type Conversation {
  id: ID!
  participantIds: [ID!]!
  participants: [UserPublic!]!
  lastMessage: ChatMessage
  updatedAt: String!
}


# --- Game.graphql ---
# Game state types

type GameState {
  isSetActive: Boolean!
  currentSetId: String
  nextSetTime: String!
  playerCount: Int!
}

# Ably token response
type AblyTokenResponse {
  token: String!
  expires: String!
  duplicateSession: Boolean
  duplicateIp: Boolean
}


# --- Leaderboard.graphql ---
# Leaderboard types

enum LeaderboardType {
  DAILY
  WEEKLY
  ALL_TIME
}

type Leaderboard {
  type: LeaderboardType!
  entries: [LeaderboardEntry!]!
  updatedAt: String!
}

type LeaderboardEntry {
  rank: Int!
  userId: ID!
  username: String!
  displayName: String!
  score: Int!
  avatarUrl: String
  memberSince: String
}


# --- Question.graphql ---
# Question types

type Question {
  id: ID!
  text: String!
  options: [String!]!
  correctIndex: Int!
  category: String!
  difficulty: String!
  explanation: String
}

input CreateQuestionInput {
  text: String!
  options: [String!]!
  correctIndex: Int!
  category: String!
  difficulty: String!
  explanation: String
}

type QuestionConnection {
  items: [Question!]!
  nextToken: String
}


# --- Report.graphql ---
# Report types for user reporting feature

enum ReportReason {
  INAPPROPRIATE_AVATAR
  OFFENSIVE_MESSAGE
  HARASSMENT
  SPAM
}

enum ReportContext {
  CHAT_MESSAGE
  AVATAR
  PROFILE
}

enum ReportStatus {
  PENDING
  REVIEWED
  ACTIONED
  DISMISSED
}

input ReportUserInput {
  reportedUserId: ID!
  reason: ReportReason!
  context: ReportContext!
  description: String
  messageContent: String
  messageId: String
}

type ReportUserResult {
  success: Boolean!
  message: String
}

# Full report type for admin viewing
type Report @aws_cognito_user_pools {
  id: ID!
  reporterId: ID!
  reporterDisplayName: String!
  reportedUserId: ID!
  reportedUserDisplayName: String!
  reason: ReportReason!
  context: ReportContext!
  description: String
  messageContent: String
  messageId: String
  status: ReportStatus!
  createdAt: String!
  adminNotes: String
  resolvedAt: String
  resolvedBy: String
}

type ReportConnection @aws_cognito_user_pools {
  items: [Report!]!
  nextToken: String
}

# Admin message/notification types
type AdminMessage @aws_cognito_user_pools {
  id: ID!
  fromAdminId: ID!
  toUserId: ID!
  subject: String!
  content: String!
  relatedReportId: String
  read: Boolean!
  createdAt: String!
}

type AdminMessageConnection @aws_cognito_user_pools {
  items: [AdminMessage!]!
  nextToken: String
}

input SendAdminMessageInput {
  toUserId: ID!
  subject: String!
  content: String!
  relatedReportId: String
}

input UpdateReportStatusInput {
  reportId: ID!
  status: ReportStatus!
  adminNotes: String
}

# Moderation types

type Strike @aws_cognito_user_pools {
  id: ID!
  reason: String!
  relatedReportId: String
  issuedBy: ID!
  issuedAt: String!
  expiresAt: String
}

type UserModeration @aws_cognito_user_pools {
  userId: ID!
  displayName: String!
  strikes: [Strike!]!
  strikeCount: Int!
  isBanned: Boolean!
  bannedAt: String
  bannedReason: String
  bannedBy: String
}

input AddStrikeInput {
  userId: ID!
  reason: String!
  relatedReportId: String
  expiresInDays: Int
}

input BanUserInput {
  userId: ID!
  reason: String!
  relatedReportId: String
  deleteAccount: Boolean
}

type ModerationResult {
  success: Boolean!
  message: String
  moderation: UserModeration
}

# User-facing moderation info (limited view for the user themselves)
type MyStrikeInfo @aws_cognito_user_pools {
  reason: String!
  issuedAt: String!
}

type MyModerationStatus @aws_cognito_user_pools {
  strikeCount: Int!
  strikes: [MyStrikeInfo!]!
  isBanned: Boolean!
  bannedReason: String
}


# --- User.graphql ---
# User types

type User {
  id: ID!
  email: String!
  username: String!
  displayName: String!
  firstName: String
  lastName: String
  createdAt: String!
  stats: UserStats!
  subscription: UserSubscription!
  badges: [Badge!]!
  totalSkillPoints: Int!
  tipUnlockedUntil: String
  referredBy: ID
  referralCount: Int!
  moderation: MyModerationStatus
}

type UserPublic {
  id: ID!
  username: String!
  displayName: String!
  firstName: String
  lastName: String
  stats: UserStats!
  badges: [Badge!]!
  totalSkillPoints: Int!
}

type UserStats {
  totalCorrect: Int!
  totalWrong: Int!
  totalPoints: Int!
  setsPlayed: Int!
  setsWon: Int!
  currentStreak: Int!
  longestStreak: Int!
}

# Subscription types (payment tiers)
type UserSubscription {
  tier: Int!
  status: SubscriptionStatus
  provider: SubscriptionProvider
  subscriptionId: String
  customerId: String
  startedAt: String
  expiresAt: String
  cancelledAt: String
  # Gift subscription fields
  giftedBy: String
  giftedByName: String
  giftedAt: String
  giftExpiresAt: String
  giftNotificationSeen: Boolean
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
  trialing
}

enum SubscriptionProvider {
  stripe
  paypal
}

# Checkout types
type CheckoutSession {
  checkoutUrl: String!
  sessionId: String
}

input CreateCheckoutInput {
  tier: Int!
  provider: SubscriptionProvider!
  successUrl: String!
  cancelUrl: String!
}

# Gift subscription input
input GiftSubscriptionInput {
  recipientUserId: ID!
  tier: Int!
  durationDays: Int!
  message: String
}


