# --- 00-base.graphql ---
# Base schema with Query, Mutation, and Subscription roots

type Query {
  # User queries
  getMyProfile: User @aws_cognito_user_pools
  getUserProfile(userId: ID!): UserPublic
  checkDisplayNameAvailable(displayName: String!): Boolean!
  checkEmailHasGoogleAccount(email: String!): Boolean!

  # Leaderboard queries
  getLeaderboard(type: LeaderboardType!, limit: Int): Leaderboard
  getMyRank(type: LeaderboardType!): Int @aws_cognito_user_pools

  # Game state queries
  getGameState: GameState

  # Question queries (admin only)
  listQuestions(limit: Int, nextToken: String): QuestionConnection @aws_cognito_user_pools

  # Ably token for real-time
  getAblyToken: AblyTokenResponse @aws_cognito_user_pools

  # Chat queries
  getChatMessages(channelId: ID!, limit: Int, nextToken: String): ChatMessageConnection @aws_cognito_user_pools
  getMyConversations(limit: Int): [Conversation!]! @aws_cognito_user_pools

  # Admin queries
  getWebhookLogs(provider: String, limit: Int, nextToken: String): WebhookLogConnection! @aws_cognito_user_pools
}

type Mutation {
  # User mutations
  updateDisplayName(displayName: String!): User @aws_cognito_user_pools
  ensureProfile(displayName: String!): User @aws_cognito_user_pools

  # Subscription mutations
  createCheckoutSession(input: CreateCheckoutInput!): CheckoutSession @aws_cognito_user_pools

  # Tip jar mutation
  createTipCheckout(provider: SubscriptionProvider!): CheckoutSession @aws_cognito_user_pools

  # Admin mutations
  createQuestion(input: CreateQuestionInput!): Question @aws_cognito_user_pools
  seedQuestions(questions: [CreateQuestionInput!]!): Int @aws_cognito_user_pools

  # Chat mutations (needed in base for @aws_subscribe to work)
  sendChatMessage(channelId: ID!, content: String!): ChatMessage @aws_cognito_user_pools
  startConversation(targetUserId: ID!): Conversation @aws_cognito_user_pools

  # Admin mutations
  adminUpdateUserTier(userId: ID!, tier: Int!): User @aws_cognito_user_pools
  adminGiftSubscription(input: GiftSubscriptionInput!): User @aws_cognito_user_pools

  # Gift notification mutations
  markGiftNotificationSeen: Boolean @aws_cognito_user_pools
}

type Subscription {
  # Chat subscriptions
  onNewChatMessage(channelId: ID!): ChatMessage @aws_subscribe(mutations: ["sendChatMessage"]) @aws_cognito_user_pools
}


# --- Admin.graphql ---
# Admin types and queries

type WebhookLog {
  eventId: ID!
  provider: String!
  eventType: String!
  payload: String!
  status: String!
  errorMessage: String
  createdAt: String!
}

type WebhookLogConnection {
  items: [WebhookLog!]!
  nextToken: String
}

# Query fields are defined in 00-base.graphql to avoid extend type issues with AppSync


# --- Badge.graphql ---
# Badge and Award types

enum AwardRarity {
  common
  uncommon
  rare
  epic
  legendary
}

type Badge {
  id: ID!
  name: String!
  description: String!
  icon: String!
  groupId: String!
  tier: Int!
  rarity: AwardRarity!
  skillPoints: Int!
  earnedAt: String!
}

type BadgeGroup {
  id: ID!
  name: String!
  description: String!
  showHighestOnly: Boolean!
  badges: [BadgeDefinition!]!
}

type BadgeDefinition {
  id: ID!
  name: String!
  description: String!
  icon: String!
  groupId: String!
  tier: Int!
  rarity: AwardRarity!
  skillPoints: Int!
  requirement: Int!
}

# User's badge summary for display
type UserBadgeSummary {
  badges: [Badge!]!
  totalSkillPoints: Int!
  badgeCount: Int!
}


# --- Chat.graphql ---
# Chat types
# Note: Chat queries, mutations and subscriptions are in 00-base.graphql

type ChatMessage {
  id: ID!
  channelId: ID!
  senderId: ID!
  senderUsername: String!
  senderDisplayName: String!
  content: String!
  createdAt: String!
}

type ChatMessageConnection {
  items: [ChatMessage!]!
  nextToken: String
}

type Conversation {
  id: ID!
  participantIds: [ID!]!
  participants: [UserPublic!]!
  lastMessage: ChatMessage
  updatedAt: String!
}


# --- Game.graphql ---
# Game state types

type GameState {
  isSetActive: Boolean!
  currentSetId: String
  nextSetTime: String!
  playerCount: Int!
}

# Ably token response
type AblyTokenResponse {
  token: String!
  expires: String!
  duplicateSession: Boolean
  duplicateIp: Boolean
}


# --- Leaderboard.graphql ---
# Leaderboard types

enum LeaderboardType {
  DAILY
  WEEKLY
  ALL_TIME
}

type Leaderboard {
  type: LeaderboardType!
  entries: [LeaderboardEntry!]!
  updatedAt: String!
}

type LeaderboardEntry {
  rank: Int!
  userId: ID!
  username: String!
  displayName: String!
  score: Int!
  avatarUrl: String
  memberSince: String
}


# --- Question.graphql ---
# Question types

type Question {
  id: ID!
  text: String!
  options: [String!]!
  correctIndex: Int!
  category: String!
  difficulty: String!
  explanation: String
}

input CreateQuestionInput {
  text: String!
  options: [String!]!
  correctIndex: Int!
  category: String!
  difficulty: String!
  explanation: String
}

type QuestionConnection {
  items: [Question!]!
  nextToken: String
}


# --- User.graphql ---
# User types

type User {
  id: ID!
  email: String!
  username: String!
  displayName: String!
  createdAt: String!
  stats: UserStats!
  subscription: UserSubscription!
  badges: [Badge!]!
  totalSkillPoints: Int!
  tipUnlockedUntil: String
}

type UserPublic {
  id: ID!
  username: String!
  displayName: String!
  stats: UserStats!
  badges: [Badge!]!
  totalSkillPoints: Int!
}

type UserStats {
  totalCorrect: Int!
  totalWrong: Int!
  totalPoints: Int!
  setsPlayed: Int!
  setsWon: Int!
  currentStreak: Int!
  longestStreak: Int!
}

# Subscription types (payment tiers)
type UserSubscription {
  tier: Int!
  status: SubscriptionStatus
  provider: SubscriptionProvider
  subscriptionId: String
  customerId: String
  startedAt: String
  expiresAt: String
  cancelledAt: String
  # Gift subscription fields
  giftedBy: String
  giftedByName: String
  giftedAt: String
  giftExpiresAt: String
  giftNotificationSeen: Boolean
}

enum SubscriptionStatus {
  active
  cancelled
  past_due
  trialing
}

enum SubscriptionProvider {
  stripe
  paypal
}

# Checkout types
type CheckoutSession {
  checkoutUrl: String!
  sessionId: String
}

input CreateCheckoutInput {
  tier: Int!
  provider: SubscriptionProvider!
  successUrl: String!
  cancelUrl: String!
}

# Gift subscription input
input GiftSubscriptionInput {
  recipientUserId: ID!
  tier: Int!
  durationDays: Int!
  message: String
}


