# Base schema with Query, Mutation, and Subscription roots

type Query {
  # User queries
  getMyProfile: User @aws_cognito_user_pools
  getUserProfile(userId: ID!): UserPublic
  checkDisplayNameAvailable(displayName: String!): Boolean! @aws_iam
  checkEmailHasGoogleAccount(email: String!): Boolean! @aws_iam
  checkEmailHasFacebookAccount(email: String!): Boolean! @aws_iam

  # Leaderboard queries
  getLeaderboard(type: LeaderboardType!, limit: Int): Leaderboard
  getMyRank(type: LeaderboardType!): Int @aws_cognito_user_pools

  # Game state queries
  getGameState: GameState

  # Room list query (polled by frontend every 10 seconds)
  getRoomList: RoomListState @aws_iam @aws_cognito_user_pools

  # Question queries (admin only)
  listQuestions(limit: Int, nextToken: String): QuestionConnection @aws_cognito_user_pools

  # Ably token for real-time
  getAblyToken: AblyTokenResponse @aws_cognito_user_pools

  # Chat queries
  getChatMessages(channelId: ID!, limit: Int, nextToken: String): ChatMessageConnection @aws_cognito_user_pools
  getMyConversations(limit: Int): [Conversation!]! @aws_cognito_user_pools

  # Admin queries
  getWebhookLogs(provider: String, limit: Int, nextToken: String): WebhookLogConnection! @aws_cognito_user_pools
  getReports(status: ReportStatus, limit: Int, nextToken: String): ReportConnection! @aws_cognito_user_pools
  getUserModeration(userId: ID!): UserModeration @aws_cognito_user_pools

  # Game config (admin only)
  getGameConfig: GameConfig @aws_cognito_user_pools

  # User notification queries
  getMyNotifications(limit: Int, nextToken: String): AdminMessageConnection! @aws_cognito_user_pools
  getUnreadNotificationCount: Int! @aws_cognito_user_pools
}

# Room list state from orchestrator (stored in DynamoDB)
type RoomListState @aws_iam @aws_cognito_user_pools {
  rooms: [RoomInfo!]!
  lobbyPlayerCount: Int!
  maintenanceMode: Boolean!
  maintenanceMessage: String
  updatedAt: String!
}

type RoomInfo @aws_iam @aws_cognito_user_pools {
  id: ID!
  name: String!
  status: String!
  difficulty: String!
  currentPlayers: Int!
  maxPlayers: Int!
  inProgress: Boolean!
  currentQuestion: Int
}

type DeleteAccountResult {
  success: Boolean!
  message: String!
}

type Mutation {
  # User mutations
  updateDisplayName(displayName: String!): User @aws_cognito_user_pools
  ensureProfile(displayName: String!): User @aws_cognito_user_pools
  deleteMyAccount: DeleteAccountResult! @aws_cognito_user_pools

  # Subscription mutations
  createCheckoutSession(input: CreateCheckoutInput!): CheckoutSession @aws_cognito_user_pools

  # Tip jar mutation
  createTipCheckout(provider: SubscriptionProvider!): CheckoutSession @aws_cognito_user_pools

  # Admin mutations
  createQuestion(input: CreateQuestionInput!): Question @aws_cognito_user_pools
  seedQuestions(questions: [CreateQuestionInput!]!): Int @aws_cognito_user_pools

  # Chat mutations (needed in base for @aws_subscribe to work)
  sendChatMessage(channelId: ID!, content: String!): ChatMessage @aws_cognito_user_pools
  startConversation(targetUserId: ID!, targetDisplayName: String!): Conversation @aws_cognito_user_pools

  # Admin mutations
  adminUpdateUserTier(userId: ID!, tier: Int!): User @aws_cognito_user_pools
  adminGiftSubscription(input: GiftSubscriptionInput!): User @aws_cognito_user_pools

  # Gift notification mutations
  markGiftNotificationSeen: Boolean @aws_cognito_user_pools

  # Game config mutations (admin only)
  updateGameConfig(input: UpdateGameConfigInput!): GameConfig @aws_cognito_user_pools

  # Invite mutations
  sendInvite(friendName: String!, email: String!, recaptchaToken: String!): Boolean @aws_cognito_user_pools
  recordReferral(referrerId: ID!): Boolean @aws_cognito_user_pools

  # Contact form mutation (public - uses reCAPTCHA for protection)
  sendContact(name: String!, email: String!, subject: String!, message: String!, recaptchaToken: String!): Boolean @aws_iam

  # Report user mutation
  reportUser(input: ReportUserInput!): ReportUserResult! @aws_cognito_user_pools

  # Admin report management
  updateReportStatus(input: UpdateReportStatusInput!): Report @aws_cognito_user_pools
  sendAdminMessage(input: SendAdminMessageInput!): AdminMessage @aws_cognito_user_pools

  # User notification mutations
  markNotificationRead(notificationId: ID!): Boolean @aws_cognito_user_pools
  markAllNotificationsRead: Boolean @aws_cognito_user_pools

  # Moderation mutations (admin only)
  addStrike(input: AddStrikeInput!): ModerationResult! @aws_cognito_user_pools
  removeStrike(userId: ID!, strikeId: ID!): ModerationResult! @aws_cognito_user_pools
  banUser(input: BanUserInput!): ModerationResult! @aws_cognito_user_pools
  unbanUser(userId: ID!): ModerationResult! @aws_cognito_user_pools
}

type Subscription {
  # Chat subscriptions
  onNewChatMessage(channelId: ID!): ChatMessage @aws_subscribe(mutations: ["sendChatMessage"]) @aws_cognito_user_pools
}
