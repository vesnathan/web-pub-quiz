AWSTemplateFormatVersion: "2010-09-09"
Description: "Quiz Night Live - Lambda Functions"

Parameters:
  Stage:
    Type: String
    Description: Deployment stage
  AppName:
    Type: String
    Description: Application Name
  TemplateBucketName:
    Type: String
    Description: S3 bucket for Lambda code
  DataTableName:
    Type: String
    Description: DynamoDB table name
  DataTableArn:
    Type: String
    Description: DynamoDB table ARN
  UserPoolId:
    Type: String
    Description: Cognito User Pool ID
  LogRetentionInDays:
    Type: Number
    Description: CloudWatch log retention
    Default: 14
  AblyApiKey:
    Type: String
    Description: Ably API key
    NoEcho: true

Resources:
  # Ably Token Auth Lambda - generates Ably tokens for authenticated users
  # Also handles anti-cheat session tracking (stores sessions in DynamoDB)
  GetAblyTokenFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-get-ably-token-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt GetAblyTokenRole.Arn
      Timeout: 10
      Environment:
        Variables:
          ABLY_API_KEY: !Ref AblyApiKey
          TABLE_NAME: !Ref DataTableName
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/getAblyToken.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  GetAblyTokenRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-get-ably-token-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:DeleteItem
                  - dynamodb:Query
                Resource:
                  - !Ref DataTableArn
                  - !Sub "${DataTableArn}/index/*"
      Tags:
        - Key: Project
          Value: quiz-night-live

  GetAblyTokenLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-get-ably-token-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Ensure Profile Lambda - creates profiles for OAuth users on first login
  EnsureProfileFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-ensure-profile-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt EnsureProfileRole.Arn
      Timeout: 10
      Environment:
        Variables:
          TABLE_NAME: !Ref DataTableName
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/ensureProfile.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  EnsureProfileRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-ensure-profile-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:Query
                Resource:
                  - !Ref DataTableArn
                  - !Sub "${DataTableArn}/index/*"
      Tags:
        - Key: Project
          Value: quiz-night-live

  EnsureProfileLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-ensure-profile-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Check Email Has Google Account Lambda - checks if email is registered with Google
  CheckEmailHasGoogleAccountFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-check-email-google-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt CheckEmailHasGoogleAccountRole.Arn
      Timeout: 10
      Environment:
        Variables:
          USER_POOL_ID: !Ref UserPoolId
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/checkEmailHasGoogleAccount.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  CheckEmailHasGoogleAccountRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-check-email-google-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: CognitoListUsers
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - cognito-idp:ListUsers
                Resource:
                  - !Sub "arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${UserPoolId}"
      Tags:
        - Key: Project
          Value: quiz-night-live

  CheckEmailHasGoogleAccountLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-check-email-google-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Note: Orchestrator is now running on Fargate, not Lambda
  # See deploy/resources/Fargate/fargate.yaml

  # ============================================
  # Payment Webhook Lambdas (Stripe & PayPal)
  # ============================================

  # Stripe Webhook Lambda
  StripeWebhookFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-stripe-webhook-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt PaymentWebhookRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME: !Ref DataTableName
          STRIPE_SECRETS_ARN: !Ref StripeSecrets
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/stripeWebhook.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  StripeWebhookLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-stripe-webhook-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # PayPal Webhook Lambda
  PayPalWebhookFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-paypal-webhook-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt PaymentWebhookRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME: !Ref DataTableName
          PAYPAL_SECRETS_ARN: !Ref PayPalSecrets
          PAYPAL_API_URL: !If
            - IsProd
            - "https://api-m.paypal.com"
            - "https://api-m.sandbox.paypal.com"
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/paypalWebhook.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  PayPalWebhookLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-paypal-webhook-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Checkout Session Lambda (creates Stripe/PayPal checkout sessions)
  CreateCheckoutFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-create-checkout-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt PaymentWebhookRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME: !Ref DataTableName
          STRIPE_SECRETS_ARN: !Ref StripeSecrets
          PAYPAL_SECRETS_ARN: !Ref PayPalSecrets
          PAYPAL_API_URL: !If
            - IsProd
            - "https://api-m.paypal.com"
            - "https://api-m.sandbox.paypal.com"
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/createCheckout.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  CreateCheckoutLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-create-checkout-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Tip Checkout Lambda (one-time $2 tip for 24hr unlimited sets)
  CreateTipCheckoutFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-create-tip-checkout-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt PaymentWebhookRole.Arn
      Timeout: 30
      Environment:
        Variables:
          TABLE_NAME: !Ref DataTableName
          STRIPE_SECRETS_ARN: !Ref StripeSecrets
          PAYPAL_SECRETS_ARN: !Ref PayPalSecrets
          PAYPAL_API_URL: !If
            - IsProd
            - "https://api-m.paypal.com"
            - "https://api-m.sandbox.paypal.com"
          FRONTEND_URL: !If
            - IsProd
            - "https://quiznight.live"
            - "https://dev.quiznight.live"
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/createTipCheckout.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  CreateTipCheckoutLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-create-tip-checkout-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Shared IAM Role for Payment Lambdas
  PaymentWebhookRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-payment-webhook-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:GetItem
                  - dynamodb:PutItem
                  - dynamodb:UpdateItem
                  - dynamodb:Query
                Resource:
                  - !Ref DataTableArn
                  - !Sub "${DataTableArn}/index/*"
        - PolicyName: SecretsAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource:
                  - !Ref StripeSecrets
                  - !Ref PayPalSecrets
      Tags:
        - Key: Project
          Value: quiz-night-live

  # Secrets Manager for payment credentials
  StripeSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AppName}/stripe-${Stage}"
      Description: Stripe API credentials
      SecretString: '{"secretKey":"sk_test_placeholder","publishableKey":"pk_test_placeholder","webhookSecret":"whsec_placeholder","priceIdSupporter":"price_supporter","priceIdChampion":"price_champion","tipPriceId":"price_tip"}'
      Tags:
        - Key: Project
          Value: quiz-night-live

  PayPalSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "${AppName}/paypal-${Stage}"
      Description: PayPal API credentials
      SecretString: '{"clientId":"placeholder","clientSecret":"placeholder","webhookId":"placeholder","planIdSupporter":"P-supporter","planIdChampion":"P-champion"}'
      Tags:
        - Key: Project
          Value: quiz-night-live

  # ============================================
  # API Gateway for Webhooks
  # ============================================

  PaymentWebhookApi:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${AppName}-payment-webhooks-${Stage}"
      Description: Payment webhook endpoints for Stripe and PayPal
      ProtocolType: HTTP
      CorsConfiguration:
        AllowOrigins:
          - "*"
        AllowMethods:
          - POST
          - OPTIONS
        AllowHeaders:
          - Content-Type
          - stripe-signature
          - paypal-auth-algo
          - paypal-cert-url
          - paypal-transmission-id
          - paypal-transmission-sig
          - paypal-transmission-time
      Tags:
        Project: quiz-night-live

  PaymentWebhookApiStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref PaymentWebhookApi
      StageName: !Ref Stage
      AutoDeploy: true
      Tags:
        Project: quiz-night-live

  # Stripe Webhook Route
  StripeWebhookRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref PaymentWebhookApi
      RouteKey: "POST /webhooks/stripe"
      Target: !Sub "integrations/${StripeWebhookIntegration}"

  StripeWebhookIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref PaymentWebhookApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !GetAtt StripeWebhookFunction.Arn
      PayloadFormatVersion: "2.0"

  StripeWebhookPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref StripeWebhookFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PaymentWebhookApi}/*"

  # PayPal Webhook Route
  PayPalWebhookRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref PaymentWebhookApi
      RouteKey: "POST /webhooks/paypal"
      Target: !Sub "integrations/${PayPalWebhookIntegration}"

  PayPalWebhookIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref PaymentWebhookApi
      IntegrationType: AWS_PROXY
      IntegrationUri: !GetAtt PayPalWebhookFunction.Arn
      PayloadFormatVersion: "2.0"

  PayPalWebhookPermission:
    Type: AWS::Lambda::Permission
    Properties:
      FunctionName: !Ref PayPalWebhookFunction
      Action: lambda:InvokeFunction
      Principal: apigateway.amazonaws.com
      SourceArn: !Sub "arn:aws:execute-api:${AWS::Region}:${AWS::AccountId}:${PaymentWebhookApi}/*"

  # ============================================
  # Schema Ready Waiter - Custom Resource Lambda
  # ============================================
  # This Lambda waits for AppSync schema updates to complete.
  # It's used as a CloudFormation Custom Resource to ensure schema
  # is fully updated before resolvers are created/modified.

  SchemaReadyWaiterFunction:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub "${AppName}-schema-ready-waiter-${Stage}"
      Runtime: nodejs20.x
      Handler: index.handler
      Role: !GetAtt SchemaReadyWaiterRole.Arn
      Timeout: 120
      Code:
        S3Bucket: !Ref TemplateBucketName
        S3Key: !Sub "functions/${Stage}/schemaReadyWaiter.zip"
      Tags:
        - Key: Project
          Value: quiz-night-live

  SchemaReadyWaiterRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AppName}-schema-ready-waiter-role-${Stage}"
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: AppSyncSchemaAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - appsync:GetSchemaCreationStatus
                Resource: "*"
      Tags:
        - Key: Project
          Value: quiz-night-live

  SchemaReadyWaiterLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/aws/lambda/${AppName}-schema-ready-waiter-${Stage}"
      RetentionInDays: !Ref LogRetentionInDays
      Tags:
        - Key: Project
          Value: quiz-night-live

Conditions:
  IsProd: !Equals [!Ref Stage, "prod"]

Outputs:
  GetAblyTokenFunctionArn:
    Description: Get Ably Token Lambda ARN
    Value: !GetAtt GetAblyTokenFunction.Arn

  EnsureProfileFunctionArn:
    Description: Ensure Profile Lambda ARN
    Value: !GetAtt EnsureProfileFunction.Arn

  CreateCheckoutFunctionArn:
    Description: Create Checkout Lambda ARN
    Value: !GetAtt CreateCheckoutFunction.Arn

  CreateTipCheckoutFunctionArn:
    Description: Create Tip Checkout Lambda ARN
    Value: !GetAtt CreateTipCheckoutFunction.Arn

  CheckEmailHasGoogleAccountFunctionArn:
    Description: Check Email Has Google Account Lambda ARN
    Value: !GetAtt CheckEmailHasGoogleAccountFunction.Arn

  PaymentWebhookApiUrl:
    Description: Payment Webhook API URL
    Value: !Sub "https://${PaymentWebhookApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}"

  StripeWebhookUrl:
    Description: Stripe Webhook URL (configure in Stripe Dashboard)
    Value: !Sub "https://${PaymentWebhookApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/webhooks/stripe"

  PayPalWebhookUrl:
    Description: PayPal Webhook URL (configure in PayPal Dashboard)
    Value: !Sub "https://${PaymentWebhookApi}.execute-api.${AWS::Region}.amazonaws.com/${Stage}/webhooks/paypal"

  StripeSecretsArn:
    Description: Stripe Secrets ARN
    Value: !Ref StripeSecrets

  PayPalSecretsArn:
    Description: PayPal Secrets ARN
    Value: !Ref PayPalSecrets

  SchemaReadyWaiterFunctionArn:
    Description: Schema Ready Waiter Lambda ARN
    Value: !GetAtt SchemaReadyWaiterFunction.Arn
